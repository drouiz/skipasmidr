services:
  airflow-init:
    image: apache/airflow:${AIRFLOW_VERSION:-2.8.0}
    container_name: airflow-init-infra
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin123}@postgres-infra:5432/${AIRFLOW_DB:-airflow}
      - AIRFLOW__CORE__FERNET_KEY=${AIRFLOW_FERNET_KEY:-}
      - _AIRFLOW_DB_MIGRATE=true
      - _AIRFLOW_WWW_USER_CREATE=true
      - _AIRFLOW_WWW_USER_USERNAME=${AIRFLOW_USER:-admin}
      - _AIRFLOW_WWW_USER_PASSWORD=${AIRFLOW_PASSWORD:-admin123}
      - ADMIN_EMAIL=${ADMIN_EMAIL:-admin@localhost}
    entrypoint: /bin/bash
    command:
      - -c
      - |
        airflow db migrate
        airflow users create --role Admin --username $${_AIRFLOW_WWW_USER_USERNAME} --email $${ADMIN_EMAIL:-admin@localhost} --firstname Admin --lastname User --password $${_AIRFLOW_WWW_USER_PASSWORD} || true
    networks:
      - infra-network

  airflow-webserver:
    image: apache/airflow:${AIRFLOW_VERSION:-2.8.0}
    container_name: airflow-infra
    restart: unless-stopped
    depends_on:
      - airflow-init
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin123}@postgres-infra:5432/${AIRFLOW_DB:-airflow}
      - AIRFLOW__WEBSERVER__SECRET_KEY=${AIRFLOW_SECRET:-your-secret-key}
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/code/dags
      - PYTHONPATH=/opt/airflow/code/libs
    volumes:
      - ../../../code:/opt/airflow/code:ro
      - airflow-logs:/opt/airflow/logs
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.airflow.rule=Host(`airflow.127.0.0.1.traefik.me`)"
      - "traefik.http.routers.airflow.entrypoints=web"
      - "traefik.http.services.airflow.loadbalancer.server.port=8080"
    command: webserver
    networks:
      - infra-network

  airflow-scheduler:
    image: apache/airflow:${AIRFLOW_VERSION:-2.8.0}
    container_name: airflow-scheduler-infra
    restart: unless-stopped
    depends_on:
      - airflow-init
    environment:
      - AIRFLOW__CORE__EXECUTOR=LocalExecutor
      - AIRFLOW__DATABASE__SQL_ALCHEMY_CONN=postgresql+psycopg2://${POSTGRES_USER:-admin}:${POSTGRES_PASSWORD:-admin123}@postgres-infra:5432/${AIRFLOW_DB:-airflow}
      - AIRFLOW__CORE__DAGS_FOLDER=/opt/airflow/code/dags
      - PYTHONPATH=/opt/airflow/code/libs
    volumes:
      - ../../../code:/opt/airflow/code:ro
      - airflow-logs:/opt/airflow/logs
    command: scheduler
    networks:
      - infra-network

volumes:
  airflow-logs:

networks:
  infra-network:
    external: true
