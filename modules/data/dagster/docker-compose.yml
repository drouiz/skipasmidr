services:
  dagster-webserver:
    image: dagster/dagster-k8s:${DAGSTER_VERSION:-latest}
    container_name: dagster-infra
    restart: unless-stopped
    working_dir: /opt/dagster/dagster_home
    entrypoint:
      - dagster-webserver
      - -h
      - "0.0.0.0"
      - -p
      - "3000"
      - -w
      - /opt/dagster/dagster_home/workspace.yaml
    environment:
      DAGSTER_HOME: /opt/dagster/dagster_home
      DAGSTER_POSTGRES_HOST: postgres-infra
      DAGSTER_POSTGRES_USER: ${POSTGRES_USER:-admin}
      DAGSTER_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      DAGSTER_POSTGRES_DB: ${DAGSTER_DB:-dagster}
      PYTHONPATH: /opt/dagster/code/libs
    volumes:
      - ./workspace.yaml:/opt/dagster/dagster_home/workspace.yaml:ro
      - ./dagster.yaml:/opt/dagster/dagster_home/dagster.yaml:ro
      - dagster-data:/opt/dagster/dagster_home/storage
      - ../../../code:/opt/dagster/code:ro
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.dagster.rule=Host(`dagster.127.0.0.1.traefik.me`)"
      - "traefik.http.routers.dagster.entrypoints=web"
      - "traefik.http.services.dagster.loadbalancer.server.port=3000"
    networks:
      - infra-network

  dagster-daemon:
    image: dagster/dagster-k8s:${DAGSTER_VERSION:-latest}
    container_name: dagster-daemon-infra
    restart: unless-stopped
    working_dir: /opt/dagster/dagster_home
    entrypoint:
      - dagster-daemon
      - run
    environment:
      DAGSTER_HOME: /opt/dagster/dagster_home
      DAGSTER_POSTGRES_HOST: postgres-infra
      DAGSTER_POSTGRES_USER: ${POSTGRES_USER:-admin}
      DAGSTER_POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:-admin123}
      DAGSTER_POSTGRES_DB: ${DAGSTER_DB:-dagster}
      PYTHONPATH: /opt/dagster/code/libs
    volumes:
      - ./workspace.yaml:/opt/dagster/dagster_home/workspace.yaml:ro
      - ./dagster.yaml:/opt/dagster/dagster_home/dagster.yaml:ro
      - dagster-data:/opt/dagster/dagster_home/storage
      - ../../../code:/opt/dagster/code:ro
    networks:
      - infra-network

volumes:
  dagster-data:

networks:
  infra-network:
    external: true
